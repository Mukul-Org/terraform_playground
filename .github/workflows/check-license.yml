# .github/workflows/check-license.yml

# Copyright 2021 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: 'BUILD - Check Lisence Boilerplate'

on:
  # schedule:
  #   - cron:  '*/5 * * * *' 
  # push:
  #   branches:
  #     - main
  # pull_request:
  #   branches:
  #     - main
  #   types: [opened]
  #   paths:
  #     - '**.js'
  #     - '**Dockerfile'
  #     - '**.py'
  #     - '**.sh'
  #     - '**.tf'
  #     - '**.yaml'
  #     - '**.yml'
  workflow_dispatch:

jobs:
  license:
    name: 'Files with no License'
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      TF_IN_AUTOMATION: true
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.WORKFLOW_PAT }}

      - name: setup python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8 #install the python needed

      - name: install python packages
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        working-directory: tools

      - name: execute py script # run the check_recent_pr.py
        id: boilerplate
        run: |
          echo $GITHUB_WORKSPACE
          python check_recent_pr.py ${GITHUB_WORKSPACE}
        working-directory: tools
        continue-on-error: true

      # - name: print output
      #   run: |
      #     enter=$'\n'
      #     echo "The following files are missing the license boilerplate:$enter${{ steps.boilerplate.outputs.files }}"

      # - name: test comment
      #   run: | 
      #     curl -v -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/user

      # - name: 'Comment PR'
      #   uses: actions/github-script@0.3.0
      #   if: github.event_name == 'push' || github.event_name == 'pull_request' 
      #   with:
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     script: |
      #       github.issues.createComment({
      #         issue_number: ${{ github.event.number }},
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         body: "The following files are missing the license boilerplate:\n ${{ steps.boilerplate.outputs.files }}" 
      #       })